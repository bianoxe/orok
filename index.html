<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomorok Audio - –í–∏–¥–µ–æ—Å–≤—è–∑—å</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ============ –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ ============ */
        .main-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .logo {
            text-align: center;
            margin-bottom: 50px;
        }

        .logo h1 {
            font-size: 48px;
            color: white;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .logo p {
            color: rgba(255,255,255,0.8);
            font-size: 18px;
        }

        .menu-buttons {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .menu-btn {
            background: white;
            color: #2a5298;
            padding: 20px 40px;
            border-radius: 12px;
            border: none;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 200px;
        }

        .menu-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .menu-btn:active {
            transform: scale(0.98);
        }

        .menu-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        @media (max-width: 768px) {
            .logo h1 {
                font-size: 36px;
            }
            
            .menu-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .menu-btn {
                width: 100%;
            }
        }

        /* ============ –§–û–†–ú–´ ============ */
        .form-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .form-screen.active {
            display: flex;
        }

        .form-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-width: 450px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .form-container h2 {
            color: #2a5298;
            margin-bottom: 25px;
            font-size: 24px;
        }

        @media (max-width: 768px) {
            .form-container {
                padding: 25px 20px;
            }
            
            .form-container h2 {
                font-size: 22px;
                margin-bottom: 20px;
            }
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group small {
            color: #666;
            font-size: 12px;
            margin-top: 4px;
            display: block;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .form-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* ============ –ö–û–ú–ù–ê–¢–ê (ZOOM STYLE) ============ */
        .room-screen {
            display: none;
            min-height: 100vh;
            background: #1a1a1a;
            position: relative;
        }

        .room-screen.active {
            display: block;
        }

        /* –•–µ–¥–µ—Ä –∫–æ–º–Ω–∞—Ç—ã */
        .room-header {
            background: rgba(0,0,0,0.8);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .room-title {
            color: white;
            font-size: 18px;
            font-weight: 600;
        }

        .room-id-display {
            color: #aaa;
            font-size: 14px;
        }

        /* –°–µ—Ç–∫–∞ –≤–∏–¥–µ–æ */
        .video-grid {
            display: grid;
            gap: 10px;
            padding: 80px 20px 100px 20px;
            min-height: 100vh;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            grid-auto-rows: minmax(225px, auto);
        }

        @media (max-width: 768px) {
            .video-grid {
                grid-template-columns: 1fr;
                padding: 70px 10px 120px 10px;
            }
        }

        .video-container {
            position: relative;
            background: #2a2a2a;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 4/3;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .video-placeholder-icon {
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            color: white;
            margin-bottom: 10px;
        }

        .video-name {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
        }

        .video-status {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .status-icon {
            width: 32px;
            height: 32px;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .status-icon.muted {
            background: #f44336;
        }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–∫–∞–∫ –≤ Zoom) */
        .control-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.9);
            padding: 15px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            z-index: 100;
            flex-wrap: wrap;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn.active {
            background: #4caf50;
        }

        .control-btn.disabled {
            background: #f44336;
        }

        .control-btn.leave {
            background: #f44336;
            width: auto;
            padding: 0 25px;
            border-radius: 30px;
        }

        .control-btn.sharing {
            background: #2196F3;
        }

        .control-label {
            position: absolute;
            bottom: -25px;
            font-size: 12px;
            color: #aaa;
            white-space: nowrap;
        }

        /* –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É —Å–º–µ–Ω—ã –∫–∞–º–µ—Ä—ã –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
        .mobile-only {
            display: none;
        }

        @media (max-width: 768px) {
            .mobile-only {
                display: flex;
            }
            
            .control-bar {
                padding: 12px 10px;
                gap: 10px;
            }
            
            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .control-label {
                font-size: 10px;
                bottom: -20px;
            }
        }

        /* –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
        .hidden {
            display: none !important;
        }

        /* Loader */
        .loader {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
    <div id="mainScreen" class="main-screen">
        <div class="logo">
            <h1>üéôÔ∏è Pomorok Audio</h1>
            <p>–í–∏–¥–µ–æ—Å–≤—è–∑—å –¥–ª—è –≤—Å–µ—Ö</p>
        </div>
        <div class="menu-buttons">
            <button class="menu-btn primary" onclick="showCreateForm()">
                –°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏
            </button>
            <button class="menu-btn" onclick="showJoinForm()">
                –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
            </button>
        </div>
    </div>

    <!-- –§–û–†–ú–ê –°–û–ó–î–ê–ù–ò–Ø –õ–û–ë–ë–ò -->
    <div id="createScreen" class="form-screen">
        <div class="form-container">
            <h2>–°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏</h2>
            <div id="createError" class="error-message hidden"></div>
            
            <div class="input-group">
                <label>–í–∞—à –Ω–∏–∫:</label>
                <input type="text" id="createUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫" maxlength="20">
            </div>

            <div class="input-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ª–æ–±–±–∏:</label>
                <input type="text" id="lobbyName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í—Å—Ç—Ä–µ—á–∞ –∫–æ–º–∞–Ω–¥—ã" maxlength="50">
            </div>

            <div class="input-group">
                <label>–ü–∞—Ä–æ–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                <input type="password" id="lobbyPassword" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –ª–æ–±–±–∏" maxlength="20">
                <small>–ü–∞—Ä–æ–ª—å –∑–∞—â–∏—Ç–∏—Ç –≤–∞—à–µ –ª–æ–±–±–∏ –æ—Ç –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö</small>
            </div>

            <div class="form-buttons">
                <button class="btn-secondary" onclick="backToMain()">–ù–∞–∑–∞–¥</button>
                <button class="btn-primary" onclick="createLobby()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –§–û–†–ú–ê –ü–†–ò–°–û–ï–î–ò–ù–ï–ù–ò–Ø -->
    <div id="joinScreen" class="form-screen">
        <div class="form-container">
            <h2>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</h2>
            <div id="joinError" class="error-message hidden"></div>
            
            <div class="input-group">
                <label>–í–∞—à –Ω–∏–∫:</label>
                <input type="text" id="joinUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫" maxlength="20">
            </div>

            <div class="input-group">
                <label>ID –ª–æ–±–±–∏:</label>
                <input type="text" id="joinRoomId" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 123" maxlength="3">
            </div>

            <div class="input-group">
                <label>–ü–∞—Ä–æ–ª—å (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è):</label>
                <input type="password" id="joinPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –ª–æ–±–±–∏">
            </div>

            <div class="form-buttons">
                <button class="btn-secondary" onclick="backToMain()">–ù–∞–∑–∞–¥</button>
                <button class="btn-primary" onclick="joinLobby()">–í–æ–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù –ö–û–ú–ù–ê–¢–´ -->
    <div id="roomScreen" class="room-screen">
        <!-- –•–µ–¥–µ—Ä -->
        <div class="room-header">
            <div>
                <div class="room-title" id="roomTitle">–õ–æ–±–±–∏</div>
                <div class="room-id-display">ID: <span id="displayRoomId">---</span></div>
            </div>
        </div>

        <!-- –°–µ—Ç–∫–∞ –≤–∏–¥–µ–æ -->
        <div class="video-grid" id="videoGrid">
            <!-- –í–∏–¥–µ–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>

        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="control-bar">
            <button class="control-btn" id="micBtn" onclick="toggleMic()">
                üé§
                <span class="control-label">–ú–∏–∫—Ä–æ—Ñ–æ–Ω</span>
            </button>
            
            <button class="control-btn" id="cameraBtn" onclick="toggleCamera()">
                üìπ
                <span class="control-label">–ö–∞–º–µ—Ä–∞</span>
            </button>
            
            <button class="control-btn mobile-only" id="switchCameraBtn" onclick="switchCamera()">
                üîÑ
                <span class="control-label">–°–º–µ–Ω–∏—Ç—å</span>
            </button>
            
            <button class="control-btn" id="screenShareBtn" onclick="toggleScreenShare()">
                üñ•Ô∏è
                <span class="control-label">–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è</span>
            </button>
            
            <button class="control-btn leave" onclick="leaveLobby()">
                –í—ã–π—Ç–∏
            </button>
        </div>
    </div>

    <!-- Firebase v9 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove, onDisconnect, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCGE1Wx2UJKW9yW_smMaxLNPs6ifApOUKc",
            authDomain: "pomorok-a6aad.firebaseapp.com",
            projectId: "pomorok-a6aad",
            databaseURL: "https://pomorok-a6aad-default-rtdb.firebaseio.com",
            storageBucket: "pomorok-a6aad.firebasestorage.app",
            messagingSenderId: "1079148253568",
            appId: "1:1079148253568:web:629f5904f3f93912423165",
            measurementId: "G-S2X6Y2W6VM"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUser = null;
        let currentRoomId = null;
        let currentLobbyName = null;
        let myUserId = null;
        let peerConnections = {};
        let localStream = null;
        let screenStream = null; // –ü–æ—Ç–æ–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
        
        // –°–æ—Å—Ç–æ—è–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        let micEnabled = true;
        let cameraEnabled = true;
        let screenSharing = false;
        let currentCamera = 'user'; // 'user' = —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è, 'environment' = –∑–∞–¥–Ω—è—è

        // ICE —Å–µ—Ä–≤–µ—Ä—ã
        const iceServers = {
            iceServers: [
                { urls: 'stun:openrelay.metered.ca:80' },
                { urls: 'stun:stun.relay.metered.ca:80' },
                {
                    urls: 'turn:openrelay.metered.ca:80',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                }
            ]
        };

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –∫–æ–º–Ω–∞—Ç—ã
        function generateRoomId() {
            return Math.floor(100 + Math.random() * 900).toString();
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        window.showCreateForm = function() {
            showScreen('createScreen');
        };

        window.showJoinForm = function() {
            showScreen('joinScreen');
        };

        window.backToMain = function() {
            showScreen('mainScreen');
        };

        function showScreen(screenId) {
            document.querySelectorAll('.main-screen, .form-screen, .room-screen').forEach(s => {
                s.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–±–±–∏
        window.createLobby = async function() {
            const username = document.getElementById('createUsername').value.trim();
            const lobbyName = document.getElementById('lobbyName').value.trim();
            const password = document.getElementById('lobbyPassword').value;

            if (!username) {
                showError('createError', '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫');
                return;
            }

            if (!lobbyName) {
                showError('createError', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–æ–±–±–∏');
                return;
            }

            currentUser = username;
            currentLobbyName = lobbyName;
            currentRoomId = generateRoomId();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å ID
            const roomRef = ref(database, `rooms/${currentRoomId}`);
            const snapshot = await get(roomRef);
            
            if (snapshot.exists()) {
                currentRoomId = generateRoomId();
            }

            // –°–æ–∑–¥–∞—ë–º –ª–æ–±–±–∏ —Å –ø–∞—Ä–æ–ª–µ–º
            const lobbyRef = ref(database, `rooms/${currentRoomId}/info`);
            await set(lobbyRef, {
                name: lobbyName,
                password: password || null,
                createdAt: Date.now(),
                createdBy: username
            });

            await joinRoom();
        };

        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –ª–æ–±–±–∏
        window.joinLobby = async function() {
            const username = document.getElementById('joinUsername').value.trim();
            const roomId = document.getElementById('joinRoomId').value.trim();
            const password = document.getElementById('joinPassword').value;

            if (!username) {
                showError('joinError', '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫');
                return;
            }

            if (!/^\d{3}$/.test(roomId)) {
                showError('joinError', 'ID –ª–æ–±–±–∏ –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 3 —Ü–∏—Ñ—Ä');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ª–æ–±–±–∏
            const roomRef = ref(database, `rooms/${roomId}`);
            const snapshot = await get(roomRef);
            
            if (!snapshot.exists()) {
                showError('joinError', '–õ–æ–±–±–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                return;
            }

            const roomData = snapshot.val();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å
            if (roomData.info && roomData.info.password) {
                if (password !== roomData.info.password) {
                    showError('joinError', '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                    return;
                }
            }

            currentUser = username;
            currentRoomId = roomId;
            currentLobbyName = roomData.info?.name || '–õ–æ–±–±–∏';

            await joinRoom();
        };

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
        async function joinRoom() {
            try {
                console.log('üé¨ –ó–∞–ø—Ä–æ—Å –º–µ–¥–∏–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤...');
                
                // –ó–∞–ø—Ä–æ—Å –∫–∞–º–µ—Ä—ã –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    },
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 },
                        facingMode: currentCamera
                    }
                });

                console.log('‚úÖ –ú–µ–¥–∏–∞ –ø–æ–ª—É—á–µ–Ω–æ!');

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                myUserId = push(ref(database, `rooms/${currentRoomId}/users`)).key;

                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–º–Ω–∞—Ç—É
                const userRef = ref(database, `rooms/${currentRoomId}/users/${myUserId}`);
                await set(userRef, {
                    username: currentUser,
                    joinedAt: Date.now(),
                    micEnabled: micEnabled,
                    cameraEnabled: cameraEnabled,
                    screenSharing: screenSharing
                });

                onDisconnect(userRef).remove();

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–Ω–∞—Ç—É
                document.getElementById('roomTitle').textContent = currentLobbyName;
                document.getElementById('displayRoomId').textContent = currentRoomId;
                showScreen('roomScreen');

                // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–æ—ë –≤–∏–¥–µ–æ
                addLocalVideo();

                // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const usersRef = ref(database, `rooms/${currentRoomId}/users`);
                onValue(usersRef, (snapshot) => {
                    handleUsers(snapshot.val());
                });

                // –°–ª—É—à–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã WebRTC
                listenForSignals();

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                let errorMsg = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ';
                
                if (error.name === 'NotAllowedError') {
                    errorMsg = '–ù–µ–æ–±—Ö–æ–¥–∏–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                } else if (error.name === 'NotFoundError') {
                    errorMsg = '–ö–∞–º–µ—Ä–∞ –∏–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.';
                } else {
                    errorMsg += error.message;
                }
                
                alert(errorMsg);
                backToMain();
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ
        function addLocalVideo() {
            const videoGrid = document.getElementById('videoGrid');
            
            const container = document.createElement('div');
            container.className = 'video-container';
            container.id = 'local-video';
            
            const video = document.createElement('video');
            video.srcObject = localStream;
            video.autoplay = true;
            video.muted = true; // –°–≤–æ—ë –≤–∏–¥–µ–æ –±–µ–∑ –∑–≤—É–∫–∞
            video.playsInline = true;
            
            const nameTag = document.createElement('div');
            nameTag.className = 'video-name';
            nameTag.textContent = currentUser + ' (–í—ã)';
            
            const status = document.createElement('div');
            status.className = 'video-status';
            status.id = 'local-status';
            
            container.appendChild(video);
            container.appendChild(nameTag);
            container.appendChild(status);
            videoGrid.appendChild(container);
            
            updateLocalStatus();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–≤–æ–µ–≥–æ –≤–∏–¥–µ–æ
        function updateLocalStatus() {
            const status = document.getElementById('local-status');
            if (!status) return;
            
            status.innerHTML = '';
            
            if (!micEnabled) {
                const micIcon = document.createElement('div');
                micIcon.className = 'status-icon muted';
                micIcon.textContent = 'üé§';
                status.appendChild(micIcon);
            }
            
            if (!cameraEnabled) {
                const camIcon = document.createElement('div');
                camIcon.className = 'status-icon muted';
                camIcon.textContent = 'üìπ';
                status.appendChild(camIcon);
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
        function handleUsers(users) {
            if (!users) return;

            const videoGrid = document.getElementById('videoGrid');
            const existingVideos = new Set();

            Object.entries(users).forEach(([userId, userData]) => {
                if (userId === myUserId) return; // –°–≤–æ–π –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º

                existingVideos.add(userId);

                if (!peerConnections[userId]) {
                    createPeerConnection(userId, userData);
                } else {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    updateRemoteUserStatus(userId, userData);
                }
            });

            // –£–¥–∞–ª—è–µ–º –æ—Ç–∫–ª—é—á–∏–≤—à–∏—Ö—Å—è
            Object.keys(peerConnections).forEach(userId => {
                if (!users[userId]) {
                    const videoElement = document.getElementById(`video-${userId}`);
                    if (videoElement) videoElement.remove();
                    
                    if (peerConnections[userId]) {
                        peerConnections[userId].close();
                        delete peerConnections[userId];
                    }
                }
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        async function createPeerConnection(userId, userData) {
            const pc = new RTCPeerConnection(iceServers);
            peerConnections[userId] = pc;

            // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });

            // –ü–æ–ª—É—á–∞–µ–º —É–¥–∞–ª—ë–Ω–Ω—ã–π –ø–æ—Ç–æ–∫
            pc.ontrack = (event) => {
                addRemoteVideo(userId, userData, event.streams[0]);
            };

            // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    const candidateRef = ref(database, `rooms/${currentRoomId}/signals/${userId}/${myUserId}/candidates`);
                    push(candidateRef, event.candidate.toJSON());
                }
            };

            // –°–æ–∑–¥–∞—ë–º offer –µ—Å–ª–∏ –Ω–∞—à ID –º–µ–Ω—å—à–µ
            if (myUserId < userId) {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                const offerRef = ref(database, `rooms/${currentRoomId}/signals/${userId}/${myUserId}/offer`);
                await set(offerRef, {
                    type: offer.type,
                    sdp: offer.sdp
                });
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ
        function addRemoteVideo(userId, userData, stream) {
            let container = document.getElementById(`video-${userId}`);
            
            if (!container) {
                const videoGrid = document.getElementById('videoGrid');
                
                container = document.createElement('div');
                container.className = 'video-container';
                container.id = `video-${userId}`;
                
                const video = document.createElement('video');
                video.srcObject = stream;
                video.autoplay = true;
                video.playsInline = true;
                
                const nameTag = document.createElement('div');
                nameTag.className = 'video-name';
                nameTag.textContent = userData.username;
                
                const status = document.createElement('div');
                status.className = 'video-status';
                status.id = `status-${userId}`;
                
                container.appendChild(video);
                container.appendChild(nameTag);
                container.appendChild(status);
                videoGrid.appendChild(container);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã
            updateRemoteUserStatus(userId, userData);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function updateRemoteUserStatus(userId, userData) {
            const status = document.getElementById(`status-${userId}`);
            if (!status) return;
            
            status.innerHTML = '';
            
            // –ò–∫–æ–Ω–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
            if (!userData.micEnabled) {
                const micIcon = document.createElement('div');
                micIcon.className = 'status-icon muted';
                micIcon.textContent = 'üé§';
                status.appendChild(micIcon);
            }
            
            // –ò–∫–æ–Ω–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–Ω–æ–π –∫–∞–º–µ—Ä—ã
            if (!userData.cameraEnabled) {
                const camIcon = document.createElement('div');
                camIcon.className = 'status-icon muted';
                camIcon.textContent = 'üìπ';
                status.appendChild(camIcon);
            }
            
            // –ò–∫–æ–Ω–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
            if (userData.screenSharing) {
                const screenIcon = document.createElement('div');
                screenIcon.className = 'status-icon';
                screenIcon.style.background = '#2196F3';
                screenIcon.textContent = 'üñ•Ô∏è';
                status.appendChild(screenIcon);
            }
        }

        // –°–ª—É—à–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã WebRTC
        function listenForSignals() {
            const mySignalsRef = ref(database, `rooms/${currentRoomId}/signals/${myUserId}`);
            
            onValue(mySignalsRef, async (snapshot) => {
                const signals = snapshot.val();
                if (!signals) return;

                for (const [fromUserId, signalData] of Object.entries(signals)) {
                    if (!peerConnections[fromUserId]) continue;

                    const pc = peerConnections[fromUserId];

                    if (signalData.offer && pc.signalingState === 'stable') {
                        await pc.setRemoteDescription(new RTCSessionDescription(signalData.offer));
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        
                        const answerRef = ref(database, `rooms/${currentRoomId}/signals/${fromUserId}/${myUserId}/answer`);
                        await set(answerRef, {
                            type: answer.type,
                            sdp: answer.sdp
                        });
                    }

                    if (signalData.answer && pc.signalingState === 'have-local-offer') {
                        await pc.setRemoteDescription(new RTCSessionDescription(signalData.answer));
                    }

                    if (signalData.candidates) {
                        Object.values(signalData.candidates).forEach(async (candidate) => {
                            try {
                                await pc.addIceCandidate(new RTCIceCandidate(candidate));
                            } catch (e) {
                                console.error('ICE error:', e);
                            }
                        });
                    }
                }
            });
        }

        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function updateUserStatus() {
            if (!myUserId || !currentRoomId) return;
            
            const userRef = ref(database, `rooms/${currentRoomId}/users/${myUserId}`);
            await set(userRef, {
                username: currentUser,
                joinedAt: Date.now(),
                micEnabled: micEnabled,
                cameraEnabled: cameraEnabled,
                screenSharing: screenSharing
            });
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º
        window.toggleMic = async function() {
            if (!localStream) return;
            
            micEnabled = !micEnabled;
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = micEnabled;
            }
            
            const btn = document.getElementById('micBtn');
            btn.classList.toggle('disabled', !micEnabled);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ Firebase
            await updateUserStatus();
            
            updateLocalStatus();
        };

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π
        window.toggleCamera = async function() {
            if (!localStream) return;
            
            cameraEnabled = !cameraEnabled;
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = cameraEnabled;
            }
            
            const btn = document.getElementById('cameraBtn');
            btn.classList.toggle('disabled', !cameraEnabled);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ Firebase
            await updateUserStatus();
            
            updateLocalStatus();
        };

        // –°–º–µ–Ω–∞ –∫–∞–º–µ—Ä—ã
        window.switchCamera = async function() {
            if (!localStream) return;
            
            try {
                // –ú–µ–Ω—è–µ–º –∫–∞–º–µ—Ä—É
                currentCamera = currentCamera === 'user' ? 'environment' : 'user';
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–æ—Ç–æ–∫
                localStream.getTracks().forEach(track => track.stop());
                
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–≤—É—é –∫–∞–º–µ—Ä—É
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    },
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 },
                        facingMode: currentCamera
                    }
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                const localVideo = document.querySelector('#local-video video');
                if (localVideo) {
                    localVideo.srcObject = localStream;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ peer connections
                Object.values(peerConnections).forEach(pc => {
                    const senders = pc.getSenders();
                    localStream.getTracks().forEach(track => {
                        const sender = senders.find(s => s.track && s.track.kind === track.kind);
                        if (sender) {
                            sender.replaceTrack(track);
                        }
                    });
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –∫–∞–º–µ—Ä—ã:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–º–µ–Ω–∏—Ç—å –∫–∞–º–µ—Ä—É. –í–æ–∑–º–æ–∂–Ω–æ, —É –≤–∞—Å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∫–∞–º–µ—Ä–∞.');
            }
        };

        // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞
        window.toggleScreenShare = async function() {
            try {
                if (!screenSharing) {
                    // –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é
                    screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: {
                            cursor: 'always',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        },
                        audio: false
                    });

                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä–Ω—É—é –∫–Ω–æ–ø–∫—É
                    screenStream.getVideoTracks()[0].onended = () => {
                        stopScreenShare();
                    };

                    // –ó–∞–º–µ–Ω—è–µ–º –≤–∏–¥–µ–æ—Ç—Ä–µ–∫ –Ω–∞ –≤—Å–µ—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è—Ö
                    const screenTrack = screenStream.getVideoTracks()[0];
                    Object.values(peerConnections).forEach(pc => {
                        const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
                        if (sender) {
                            sender.replaceTrack(screenTrack);
                        }
                    });

                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                    const localVideo = document.querySelector('#local-video video');
                    if (localVideo) {
                        localVideo.srcObject = screenStream;
                    }

                    screenSharing = true;
                    document.getElementById('screenShareBtn').classList.add('sharing');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ Firebase
                    await updateUserStatus();

                } else {
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é
                    stopScreenShare();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞:', error);
                if (error.name === 'NotAllowedError') {
                    alert('–í—ã –æ—Ç–∫–ª–æ–Ω–∏–ª–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é —ç–∫—Ä–∞–Ω–∞.');
                }
            }
        };

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
        async function stopScreenShare() {
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }

            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–º–µ—Ä—É
            const cameraTrack = localStream.getVideoTracks()[0];
            if (cameraTrack) {
                Object.values(peerConnections).forEach(pc => {
                    const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
                    if (sender) {
                        sender.replaceTrack(cameraTrack);
                    }
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                const localVideo = document.querySelector('#local-video video');
                if (localVideo) {
                    localVideo.srcObject = localStream;
                }
            }

            screenSharing = false;
            document.getElementById('screenShareBtn').classList.remove('sharing');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ Firebase
            await updateUserStatus();
        }

        // –í—ã—Ö–æ–¥ –∏–∑ –ª–æ–±–±–∏
        window.leaveLobby = async function() {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é —ç–∫—Ä–∞–Ω–∞ –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }

            Object.values(peerConnections).forEach(pc => pc.close());
            peerConnections = {};

            if (myUserId && currentRoomId) {
                const userRef = ref(database, `rooms/${currentRoomId}/users/${myUserId}`);
                const signalsRef = ref(database, `rooms/${currentRoomId}/signals/${myUserId}`);
                await remove(userRef);
                await remove(signalsRef);
            }

            document.getElementById('videoGrid').innerHTML = '';
            screenSharing = false;
            currentRoomId = null;
            myUserId = null;
            backToMain();
        };

        // –ü–æ–∫–∞–∑ –æ—à–∏–±–æ–∫
        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            setTimeout(() => errorEl.classList.add('hidden'), 5000);
        }

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', () => {
            if (currentRoomId && myUserId) {
                const userRef = ref(database, `rooms/${currentRoomId}/users/${myUserId}`);
                remove(userRef);
            }
        });
    </script>
</body>

</html>
